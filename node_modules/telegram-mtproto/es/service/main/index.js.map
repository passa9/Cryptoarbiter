{"version":3,"sources":["../../../src/service/main/index.js"],"names":["EventEmitter","ApiManager","NetworkerFabric","PureStorage","TL","configValidator","generateInvokeLayer","api57","require","mtproto57","apiConfig","invokeWithLayer","layer","initConnection","api_id","device_model","system_version","app_version","lang_code","MTProto","constructor","config","emitter","wildcard","on","bind","emit","configNormalization","tls","schema","mtSchema","netFabric","api","app","storage","server","publicKeys","publisKeysHex","apiNormalized","invokeLayer","fullCfg","modulus","exponent"],"mappings":"AAEA,OAAOA,YAAP,MAAyB,eAAzB;;AAEA,SAASC,UAAT,QAA2B,gBAA3B;AACA,OAAOC,eAAP,MAA4B,cAA5B;AACA,SAASC,WAAT,QAA4B,aAA5B;AACA,OAAOC,EAAP,MAAe,UAAf;;AAEA,OAAOC,eAAP,MAA4B,qBAA5B;AACA,OAAOC,mBAAP,MAAgC,0BAAhC;;AAMA,IAAMC,QAAQC,QAAQ,6BAAR,CAAd;AACA,IAAMC,YAAYD,QAAQ,iCAAR,CAAlB;;AAEA,IAAME,YAAuB;AAC3BC,mBAAiB,UADU;AAE3BC,SAAiB,EAFU;AAG3BC,kBAAiB,UAHU;AAI3BC,UAAiB,KAJU;AAK3BC,gBAAiB,mBALU;AAM3BC,kBAAiB,kBANU;AAO3BC,eAAiB,OAPU;AAQ3BC,aAAiB;AARU,CAA7B;;AAWA,MAAMC,OAAN,CAAc;AASZC,cAAYC,MAAZ,EAAgC;AAAA,SANhCC,OAMgC,GANtB,IAAItB,YAAJ,CAAiB;AACzBuB,gBAAU;AADe,KAAjB,CAMsB;AAAA,SAFhCC,EAEgC,GAFvB,KAAKF,OAAL,CAAaE,EAAb,CAAgBC,IAAhB,CAAqB,KAAKH,OAA1B,CAEuB;AAAA,SADhCI,IACgC,GADnB,KAAKJ,OAAL,CAAaI,IAAb,CAAkBD,IAAlB,CAAuB,KAAKH,OAA5B,CACmB;;AAC9B,SAAKD,MAAL,GAAcM,oBAAoBN,MAApB,CAAd;AACA,SAAKO,GAAL,GAAWxB,GAAG,KAAKiB,MAAL,CAAYQ,MAAf,EAAuB,KAAKR,MAAL,CAAYS,QAAnC,CAAX;AACA,QAAMC,YAAY7B,gBAAgB,KAAKmB,MAAL,CAAYW,GAA5B,EAAiC,KAAKJ,GAAtC,EAA2C,KAAKP,MAAL,CAAYY,GAAZ,CAAgBC,OAA3D,EAAoE,KAAKR,IAAzE,CAAlB;AACA,SAAKM,GAAL,GAAW,IAAI/B,UAAJ,CAAe,KAAKoB,MAApB,EAA4B,KAAKO,GAAjC,EAAsCG,SAAtC,EAAiD,EAAEP,IAAI,KAAKA,EAAX,EAAeE,MAAM,KAAKA,IAA1B,EAAjD,CAAX;AACD;AAdW;;AAiBd,eAAeP,OAAf;;AAEA,IAAMQ,sBAAuBN,MAAD,IAAsC;AAChE,MAAM;AACJc,aAAS,EADL;AAEJH,UAAM,EAFF;AAGJC,SAAK;AACHC,gBAAU/B,WADP;AAEHiC,mBAAaC;AAFV,QAGD,EANA;AAOJR,aAAStB,KAPL;AAQJuB,eAAWrB;AARP,MASFY,MATJ;AAUA,MAAMiB,kCAAqB5B,SAArB,EAAmCsB,GAAnC,CAAN;AACA,MAAMO,cAAcjC,oBAAoBgC,cAAc1B,KAAlC,CAApB;AACA0B,gBAAc3B,eAAd,GAAgC4B,WAAhC;AACA,MAAMC,UAAU;AACdL,UADc;AAEdH,SAAKM,aAFS;AAGdL,SAAK,EAAEC,OAAF,EAAWE,UAAX,EAHS;AAIdP,UAJc;AAKdC;AALc,GAAhB;AAOAzB,kBAAgBmC,OAAhB;AACA,SAAOA,OAAP;AACD,CAvBD;;AAyBA;;;;;;;;;;;;;AAaA,IAAMH,gBAA6B,CAAC;AAClCI,WACA,uEACA,oEADA,GAEA,oEAFA,GAGA,oEAHA,GAIA,oEAJA,GAKA,oEALA,GAMA,oEANA,GAOA,oDATkC;AAUlCC,YAAU;AAVwB,CAAD,CAAnC","file":"index.js","sourcesContent":["//@flow\r\n\r\nimport EventEmitter from 'eventemitter2'\r\n\r\nimport { ApiManager } from '../api-manager'\r\nimport NetworkerFabric from '../networker'\r\nimport { PureStorage } from '../../store'\r\nimport TL from '../../tl'\r\n\r\nimport configValidator from './config-validation'\r\nimport generateInvokeLayer from './invoke-layer-generator'\r\n\r\nimport type { TLFabric } from '../../tl'\r\nimport type { ApiConfig, ConfigType, StrictConfig, Emit, On, PublicKey } from './index.h'\r\nimport type { ApiManagerInstance } from '../api-manager/index.h'\r\n\r\nconst api57 = require('../../../schema/api-57.json')\r\nconst mtproto57 = require('../../../schema/mtproto-57.json')\r\n\r\nconst apiConfig: ApiConfig = {\r\n  invokeWithLayer: 0xda9b0d0d,\r\n  layer          : 57,\r\n  initConnection : 0x69796de9,\r\n  api_id         : 49631,\r\n  device_model   : 'Unknown UserAgent',\r\n  system_version : 'Unknown Platform',\r\n  app_version    : '1.0.1',\r\n  lang_code      : 'en'\r\n}\r\n\r\nclass MTProto {\r\n  config: StrictConfig\r\n  tls: TLFabric\r\n  emitter = new EventEmitter({\r\n    wildcard: true\r\n  })\r\n  api: ApiManagerInstance\r\n  on: On = this.emitter.on.bind(this.emitter)\r\n  emit: Emit = this.emitter.emit.bind(this.emitter)\r\n  constructor(config: ConfigType) {\r\n    this.config = configNormalization(config)\r\n    this.tls = TL(this.config.schema, this.config.mtSchema)\r\n    const netFabric = NetworkerFabric(this.config.api, this.tls, this.config.app.storage, this.emit)\r\n    this.api = new ApiManager(this.config, this.tls, netFabric, { on: this.on, emit: this.emit })\r\n  }\r\n}\r\n\r\nexport default MTProto\r\n\r\nconst configNormalization = (config: ConfigType): StrictConfig => {\r\n  const {\r\n    server = {},\r\n    api = {},\r\n    app: {\r\n      storage = PureStorage,\r\n      publicKeys = publisKeysHex\r\n    } = {},\r\n    schema = api57,\r\n    mtSchema = mtproto57,\r\n  } = config\r\n  const apiNormalized = { ...apiConfig, ...api }\r\n  const invokeLayer = generateInvokeLayer(apiNormalized.layer)\r\n  apiNormalized.invokeWithLayer = invokeLayer\r\n  const fullCfg = {\r\n    server,\r\n    api: apiNormalized,\r\n    app: { storage, publicKeys },\r\n    schema,\r\n    mtSchema\r\n  }\r\n  configValidator(fullCfg)\r\n  return fullCfg\r\n}\r\n\r\n/**\r\n*  Server public key, obtained from here: https://core.telegram.org/api/obtaining_api_id\r\n*\r\n* -----BEGIN RSA PUBLIC KEY-----\r\n* MIIBCgKCAQEAwVACPi9w23mF3tBkdZz+zwrzKOaaQdr01vAbU4E1pvkfj4sqDsm6\r\n* lyDONS789sVoD/xCS9Y0hkkC3gtL1tSfTlgCMOOul9lcixlEKzwKENj1Yz/s7daS\r\n* an9tqw3bfUV/nqgbhGX81v/+7RFAEd+RwFnK7a+XYl9sluzHRyVVaTTveB2GazTw\r\n* Efzk2DWgkBluml8OREmvfraX3bkHZJTKX4EQSjBbbdJ2ZXIsRrYOXfaA+xayEGB+\r\n* 8hdlLmAjbCVfaigxX0CDqWeR1yFL9kwd9P0NsZRPsmoqVwMbMu7mStFai6aIhc3n\r\n* Slv8kg9qv1m6XHVQY3PnEw+QQtqSIXklHwIDAQAB\r\n* -----END RSA PUBLIC KEY-----\r\n*/\r\n\r\nconst publisKeysHex: PublicKey[] = [{\r\n  modulus:\r\n  'c150023e2f70db7985ded064759cfecf0af328e69a41daf4d6f01b538135a6f91f' +\r\n  '8f8b2a0ec9ba9720ce352efcf6c5680ffc424bd634864902de0b4bd6d49f4e5802' +\r\n  '30e3ae97d95c8b19442b3c0a10d8f5633fecedd6926a7f6dab0ddb7d457f9ea81b' +\r\n  '8465fcd6fffeed114011df91c059caedaf97625f6c96ecc74725556934ef781d86' +\r\n  '6b34f011fce4d835a090196e9a5f0e4449af7eb697ddb9076494ca5f81104a305b' +\r\n  '6dd27665722c46b60e5df680fb16b210607ef217652e60236c255f6a28315f4083' +\r\n  'a96791d7214bf64c1df4fd0db1944fb26a2a57031b32eee64ad15a8ba68885cde7' +\r\n  '4a5bfc920f6abf59ba5c75506373e7130f9042da922179251f',\r\n  exponent: '010001'\r\n}]"]}